# Define upstreams
upstream api_v1 {
    server api-v1:8000;
}

upstream api_v2 {
    server api-v2:8000;
}

# Map for A/B testing
map $http_x_experiment_group $upstream_backend {
    default api_v1;
    debug   api_v2;
}

# Rate limiting zone
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

# Redirect HTTP to HTTPS
server {
    listen 80;
    server_name localhost;
    return 301 https://$host$request_uri;
}

# HTTPS Server
server {
    listen 443 ssl;
    server_name localhost;

    # SSL Certificates
    ssl_certificate /etc/nginx/certs/nginx.crt;
    ssl_certificate_key /etc/nginx/certs/nginx.key;

    # Monitoring endpoint (internal/basic auth could be added)
    location /nginx_status {
        stub_status;
        allow all; # For demo purposes allowing all, usually restrict.
    }

    # Main prediction endpoint
    location /predict {
        # Basic Authentication
        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;

        # Rate Limiting
        limit_req zone=api_limit burst=20 nodelay;

        # Proxy to the mapped upstream
        proxy_pass http://$upstream_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Catch-all for other paths if necessary, or just fail. 
    # API documentation etc could be served here.
}